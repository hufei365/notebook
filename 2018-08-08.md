## 不要阻塞事件循环（或工作池）

### 你应该阅读本指南吗？
如果您编写比命令行脚本更复杂的程序，那么阅读本文可以帮助您编写性能更高，更安全的应用程序。

在编写本文档时，主要是基于Node服务器。但里面的原则也适用于其它复杂的Node应用程序。在没有特别说明操作系统的情况下，默认为Linux。

### TL; DR
Node.js在事件循环（初始化和回调）中运行JavaScript代码，并提供工作池来处理成本比较高的任务，如文件I/O。 Node服务节点有很强的扩展能力，有时能提供比相对较重的Apache更好的解决方案。关键点就在于它使用少量线程来处理多客户端连接。如果Node可以使用更少的线程，那么它可以将更多的系统时间和内存用于客户端，而不是为线程（内存，上下文切换）占用额外空间和时间。但也因为Node只有少量的线程，因此在构建应用程序时，必须明智地使用它们。


这里有一些保持Node服务器快速稳健运行的经验法则： 当在任何给定时间与每个客户端关联的工作“很小”时，Node服务会很快。

这适用于事件循环上的回调和工作池上的任务。

### 为什么我要避免阻塞事件循环和工作池？
Node使用少量的线程来处理多个客户端连接。在Node中有两种类型的线程：一个事件循环（又称主循环，主线程，事件线程等），以及k工作池（也称为线程池）中的工作池。

如果一个线程需要很长时间来执行回调（Event Loop）或任务（Worker），我们称之为“阻塞”。虽然线程被阻止代表一个客户端工作，但它无法处理来自任何其他客户端的请求。这提供了阻止事件循环和工作池的两个动机：

性能：如果您经常在任一类型的线程上执行重量级活动，则服务器的吞吐量（请求/秒）将受到影响。
安全性：如果某个输入可能会阻塞某个线程，则恶意客户端可能会提交此“恶意输入”，使您的线程阻塞，并阻止其在其他客户端上工作。这将是拒绝服务攻击。
快速回顾一下Node
Node使用事件驱动架构：它有一个用于编排的事件循环和一个用于昂贵任务的工作池。

什么代码在事件循环上运行？
当它们开始时，节点应用程序首先完成初始化阶段，即require模块和注册事件的回调。然后，节点应用程序进入事件循环，通过执行适当的回调来响应传入的客户端请求。此回调同步执行，并可以注册异步请求以在完成后继续处理。这些异步请求的回调也将在事件循环上执行。

事件循环还将满足其回调（例如，网络I / O）所产生的非阻塞异步请求。

总之，Event Loop执行为事件注册的JavaScript回调，并且还负责完成非阻塞异步请求，如网络I/O.


